--Q1 Provide the name of the sales_rep in each region with the largest amount of total_amt_usd sales.


WITH MAX_ORDER_SALES AS(
SELECT ACCOUNT_ID, MAX(TOTAL_AMT_USD) AS TOTAL_AMT_USD
FROM ORDERS
GROUP BY ACCOUNT_ID
), 

MAX_ACCOUNTS_SALES AS(
SELECT A.ID, A.SALES_REP_ID, O.TOTAL_AMT_USD
FROM ACCOUNTS A
INNER JOIN MAX_ORDER_SALES O
ON A.ID=O.ACCOUNT_ID
),

MAX_SALES AS(
SELECT S.NAME, S.REGION_ID, MAX(A.TOTAL_AMT_USD) AS MAX_TOTAL_AMT_USD
FROM SALES_REPS S
INNER JOIN MAX_ACCOUNTS_SALES A 
ON S.ID=A.SALES_REP_ID
GROUP BY S.NAME, S.REGION_ID
),

MAX_REGION_SALES AS(SELECT REGION_ID, MAX(MAX_TOTAL_AMT_USD) AS MAX_TOTAL_AMT_USD
FROM MAX_SALES M
GROUP BY REGION_ID)

SELECT S.NAME,R.REGION_ID,R.MAX_TOTAL_AMT_USD
FROM MAX_SALES S
INNER JOIN MAX_REGION_SALES R 
ON S.MAX_TOTAL_AMT_USD=R.MAX_TOTAL_AMT_USD
ORDER BY R.MAX_TOTAL_AMT_USD DESC
LIMIT 1