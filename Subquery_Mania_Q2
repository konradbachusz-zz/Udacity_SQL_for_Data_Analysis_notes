--Q2 For the region with the largest (sum) of sales total_amt_usd, how many total (count) orders were placed? 


WITH MAX_ORDER_SALES AS(
SELECT ACCOUNT_ID, MAX(TOTAL_AMT_USD) AS TOTAL_AMT_USD, COUNT(ID) AS TOTAL_ORDERS
FROM ORDERS
GROUP BY ACCOUNT_ID
), 

MAX_ACCOUNTS_SALES AS(
SELECT A.ID, A.SALES_REP_ID, O.TOTAL_AMT_USD, O.TOTAL_ORDERS
FROM ACCOUNTS A
INNER JOIN MAX_ORDER_SALES O
ON A.ID=O.ACCOUNT_ID
),

MAX_SALES AS(
SELECT S.NAME, S.REGION_ID, MAX(A.TOTAL_AMT_USD) AS MAX_TOTAL_AMT_USD, COUNT(TOTAL_ORDERS) AS TOTAL_ORDERS
FROM SALES_REPS S
INNER JOIN MAX_ACCOUNTS_SALES A 
ON S.ID=A.SALES_REP_ID
GROUP BY S.NAME, S.REGION_ID
),

MAX_REGION_SALES AS(SELECT REGION_ID, MAX(MAX_TOTAL_AMT_USD) AS MAX_TOTAL_AMT_USD
FROM MAX_SALES M
GROUP BY REGION_ID)

SELECT REGION_ID, MAX(MAX_TOTAL_AMT_USD) AS MAX_TOTAL_AMT_USD, COUNT(TOTAL_ORDERS) AS TOTAL_ORDERS
FROM MAX_SALES
GROUP BY REGION_ID
ORDER BY MAX_TOTAL_AMT_USD DESC
LIMIT 1

